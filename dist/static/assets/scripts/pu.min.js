"use strict";var publicationsModule=angular.module("publications",["uuid","ngMessages","angular-redactor","ngFileUpload","cloudinary","algoliasearch"]).factory("publicationService",["$q","$window","imagesService",function(e,t,a){return{savePublication:function(a,i,o){var r=e.defer();if(angular.isDefined(o)&&""!==o){var n=i.child(o);delete a.releaseDate,delete a.images,n.update(a,function(e){e?r.reject(e):r.resolve({publicationId:o})})}else{var l=i.push();a.releaseDate=t.Firebase.ServerValue.TIMESTAMP,l.set(a,function(e){e?r.reject(e):r.resolve({publicationId:l.key()})})}return r.promise},removePublication:function(t,i){var o=e.defer(),r={};return r.deleteImages=a.deleteImages(i,null),r.detelePublication=t.child(i).remove(function(e){e?o.reject(e):o.resolve()}),e.all(r).then(function(){o.resolve()},function(e){notificationService.error(e)}),o.promise}}}]).controller("PublicationsController",["$scope","$q","$window","$filter","$routeParams","$location","$http","FireRef","$firebaseArray","$firebaseObject","rfc4122","treeService","notificationService","Upload","user","$uibModal","publicationService","imagesService","$log",function(e,t,a,i,o,r,n,l,c,s,d,u,p,m,f,b,g,h,y){function v(e){var a=t.defer(),i=I.child(e),o=s(i);return o.$loaded(function(){"undefined"==typeof o.releaseDate?a.reject("404"):f.uid!==o.userID?a.reject("401"):a.resolve({publication:o})},function(e){a.reject(e)}),a.promise}function $(a){var i=t.defer();return v(a).then(function(t){angular.forEach(t.publication,function(t,a){"releaseDate"!==a&&(e.publication.model[a]=t)})}).then(function(){e.publication.images=[],angular.forEach(e.publication.model.images,function(t,a){t.$id=a,e.publication.images.push(t)})}).then(function(){e.publication.$id=a,e.publication.categoryPath=u.getPath(e.publication.model.categoryId,e.publication.categories),e.publication.categoryPath.length>0?e.publication.categorySelected=!0:(e.publication.redefineCategory=!0,e.publication.categorySelected=!1,e.publication.model.categoryId=""),e.publication.locationPath=u.getPath(e.publication.model.locationId,e.publication.locations),0===e.publication.locationPath.length&&(e.publication.redefineLocation=!0,e.publication.model.locationId=""),e.publication.inEditMode=!0,i.resolve()},function(e){r.path("/"),i.reject(e)}),i.promise}var S=t.defer(),I=l.child("publications");e.httpRequestPromise=S.promise,e.publication={$id:"",categoryPath:[],locationPath:[],categories:c(l.child("categories").orderByChild("left")),locations:c(l.child("locations").orderByChild("left")),categorySelected:!1,inEditMode:!1,isReady:!1,model:{userID:f.uid,categoryId:"",locationId:"",featuredImageId:"",department:"",title:"",htmlDescription:"",barcode:"",barcodeType:"CODE128"}};var x=e.publication.categories.$loaded(),N=e.publication.locations.$loaded();t.all([x,N]).then(function(){return angular.isDefined(o.publicationId)?$(o.publicationId):void(e.publication.images=[])}).then(function(){e.publication.isReady=!0,S.resolve()}),e.submit=function(){if(e.publicationForm.$valid){var a=t.defer();g.savePublication(e.publication.model,I,e.publication.$id).then(function(t){return e.publication.$id=""!==e.publication.$id?e.publication.$id:t.publicationId,h.saveFiles(I,e.publication.$id,e.publication.images)}).then(function(){p.success("Data has been save"),a.resolve()},function(e){p.error(e),a.reject(e)}),e.httpRequestPromise=a.promise}else p.error("Something is missing")},e.discard=function(){var t=b.open({templateUrl:"discardPublication.html",controller:"DiscardPublicationController",resolve:{publicationId:function(){return""!==e.publication.$id},title:function(){return""!==e.publication.model.title&&void 0!==e.publication.model.title?e.publication.model.title:"Untitled"}}});t.result.then(function(){""!==e.publication.$id?e.httpRequestPromise=g.removePublication(I,e.publication.$id).then(function(){p.success("The publication has been deleted."),r.path("/")}):(p.success("The publication has been discard."),r.path("/"))},function(e){p.error(e)})}}]).controller("DiscardPublicationController",["$scope","$modalInstance","publicationId","title",function(e,t,a,i){e.publication={$id:a,title:i},e.confirm=function(){t.close()},e.cancel=function(){t.dismiss("This has be cancel")}}]).directive("locationInput",["treeService",function(e){return{scope:{formName:"=",locations:"=",model:"=",redefineLocation:"=",locationPath:"="},template:'<div><hr class="hr-xs"><label class="control-label"><i class="fa fa-map-marker"></i> Location <sup style="color: red;">*</sup></label><div class="list-group" style="margin-bottom: 0"><button type="button" class="list-group-item" ng-click="setLocation(location.$id); publication.redefineLocation = false;" ng-repeat="location in locations | filter:{parentId: model.locationId}:true" ><i style="color: #286090" class="fa fa-folder"></i> {{location.name | capitalizeFirstChar}}</button></div><ol ng-show="locationPath.length > 0" class="breadcrumb" style="margin-bottom: 0; margin-top: 10px;"><li ng-click="model.locationId =\'\'; locationPath =[];" class="a-link"> Reset </li><li ng-repeat="location in locationPath" ng-click="setLocation(location.$id)" ng-class="{\'a-link\': !$last}"> {{location.name | capitalizeFirstChar}} </li></ol><input name="location" ng-model="model.locationId" required class="form-control" placeholder="" type="text" style="display: none;"><div data-ng-messages="formName.$submitted && formName.location.$error" class="help-block"><div data-ng-message="required" >- The <b>Location</b> is required.</div></div><div ng-show="formName.redefineLocation === true" class="alert alert-danger alert-xs" style="margin-bottom: 10px;" role="alert"><b>NOTE: Sorry, but we need to redefine the location.</b></div><div class="alert alert-info alert-xs" style="margin-bottom: 0; margin-top: 10px;" role="alert">NOTE: Select the <b>location</b> that best suits to the publication. No matter if it is too general or specific, the important thing is to select one.</div></div>',link:function(t){t.setLocation=function(a){t.model.locationId=a,t.locationPath=e.getPath(a,t.locations),t.model.locations=e.pathNames(t.locationPath)}}}}]).directive("categorySelector",["treeService",function(e){return{restrict:"E",scope:{categoryPath:"=",categorySelected:"=",isReady:"=",inEditMode:"=",model:"=",categories:"=",redefineCategory:"="},template:'<div class="panel panel-default" ng-show="categorySelected === false && isReady"><div class="panel-heading"><h3 class="panel-title" ng-switch="inEditMode"><span ng-switch-when="false" >New Publication - Select a category:</span><span ng-switch-when="true">Edit Publication</span></h3></div><div class="list-group"><button type="button" class="list-group-item" ng-click="setCategory(category.$id)" ng-repeat="category in categories | filter:{parentId: model.categoryId}:true" ><i style="color: #286090" class="fa" ng-class="{\'fa-folder\': (category.name !== \'Marketplace\' && category.name !== \'Jobs\' && category.name !== \'Real Estate\' && category.name !== \'Transport\' && category.name !== \'Services\') , \'fa-shopping-cart\': (category.name === \'Marketplace\') , \'fa-suitcase\': (category.name === \'Jobs\'), \'fa-home\': (category.name === \'Real Estate\'), \'fa-car\': (category.name === \'Transport\'), \'fa-wrench\' : (category.name === \'Services\')}"></i> {{category.name | capitalizeFirstChar}}</button></div><div class="panel-body"><ol ng-show="categoryPath.length > 0" class="breadcrumb" style="margin-bottom: 7px;"><li ng-click="model.categoryId = \'\'; categoryPath =[];" class="a-link"> Reset </li><li ng-repeat="category in categoryPath" ng-click="setCategory(category.$id)" ng-class="{\'a-link\': !$last}"> {{category.name | capitalizeFirstChar}} </li></ol><div ng-show="redefineCategory === true" class="alert alert-danger alert-xs" style="margin-bottom: 10px;" role="alert"><b>NOTE: Sorry, but we need to redefine the category.</b></div><div class="alert alert-info alert-xs" style="margin-bottom: 0;" role="alert">NOTE: Select the category that best suits to the publication. No matter if it is too general or specific, the important thing is to select one.</div></div><div class="panel-footer" style="text-align: right;"><button ng-click="categorySelected = true; redefineCategory = false" type="button" class="btn btn-primary" ng-disabled="model.categoryId ===\'\'" ><i class="fa fa-check"></i> Confirm selection</button></div></div>',link:function(t){t.setCategory=function(a){t.model.categoryId=a,t.categoryPath=e.getPath(a,t.categories),t.model.categories=e.pathNames(t.categoryPath),t.model.department=t.categoryPath[0]?t.categoryPath[0].name:""}}}}]).directive("descriptionInput",["$filter",function(e){return{restrict:"E",scope:{formName:"=",model:"="},template:'<div class="form-group"><label class="control-label"><span class="glyphicon glyphicon-book"></span> Description <sup style="color: red;">*</sup></label><textarea redactor name="htmlDescription" data-ng-model="model.htmlDescription" required class="form-control" placeholder=""></textarea><div data-ng-messages="formName.$submitted && formName.htmlDescription.$error" class="help-block"><div data-ng-message="required" >- The <b>description</b> is required.</div></div></div>',link:function(t){t.$watch(function(e){return e.model.htmlDescription},function(){t.model.description=e("htmlToPlaintext")(t.model.htmlDescription)})}}}]).directive("warrantyInput",["$filter",function(e){return{restrict:"E",scope:{formName:"=",model:"="},template:'<div class="form-group"><label class="control-label"><i class="fa fa-certificate"></i> Warranty <sup style="color: red;">*</sup></label><textarea redactor name="htmlWarranty" data-ng-model="model.htmlWarranty" required class="form-control" placeholder=""></textarea><div data-ng-messages="formName.$submitted && formName.htmlWarranty.$error" class="help-block"><div data-ng-message="required" >- The <b>Warranty</b> is required.</div></div></div>',link:function(t){t.$watch(function(e){return e.model.htmlWarranty},function(){t.model.warranty=e("htmlToPlaintext")(t.model.htmlWarranty)})}}}]).directive("titleInput",["$filter",function(e){return{restrict:"E",scope:{formName:"=",model:"="},template:'<div class="form-group"><label class="control-label"><span class="glyphicon glyphicon-bookmark"></span> Title <sup style="color: red;">*</sup></label><input type="text" name="title" ng-model="model.title" required minlength="7" capitalize-first-char class="form-control" placeholder=""><div data-ng-messages="formName.$submitted && formName.title.$error" class="help-block"><div data-ng-message="required">- The <b>title</b> is required.</div><div data-ng-message="minlength" >- The <b>title</b> must be at least 7 characters long.</div></div></div>'}}]).directive("quantityInput",[function(){return{restrict:"E",scope:{formName:"=",model:"="},template:'<div class="form-group" ><div class="row"><div class="col-xs-4"><label class="control-label"><i class="fa fa-cubes"></i> Quantity in stock <sup style="color: red;">*</sup></label><div class="input-group"><div class="input-group-addon">Units</div><input name="quantity" ng-model="model.quantity" required class="form-control" placeholder="Eje: 100" type="number"></div><div data-ng-messages="formName.$submitted && formName.quantity.$error" class="help-block"><div data-ng-message="required">- The <b>quantity</b> is required.</div></div></div></div></div>'}}]).directive("priceInput",[function(){return{restrict:"E",scope:{formName:"=",model:"="},template:'<div class="form-group" ><div class="row"><div class="col-xs-4"><label class="control-label"><span class="glyphicon glyphicon-tag"></span> Price <sup style="color: red;">*</sup></label><div class="input-group"><div class="input-group-addon">Â£</div><input name="price" ng-model="model.price" required class="form-control" placeholder="Eje: 1000" type="number"></div><div data-ng-messages="formName.$submitted && formName.price.$error" class="help-block"><div data-ng-message="required">- The <b>price</b> is required.</div></div></div></div></div>'}}]).directive("jobTypeSelect",[function(){return{restrict:"E",scope:{model:"="},template:'<hr class="hr-xs"><label><i class="fa fa-random"></i> Job type</label><div class="row" style="margin-bottom: 10px;"><div class="col-xs-5"><select class="form-control" ng-model="model.jobType"><option ng-repeat="type in jobTypes" value="{{type}}">{{type}}</option></select></div></div>',link:function(e){"undefined"==typeof e.model.jobType&&(e.model.jobType="Permanent"),e.jobTypes=["Permanent","Contract"]}}}]).directive("salaryInput",[function(){return{restrict:"E",scope:{formName:"=",model:"="},template:'<hr class="hr-xs"><div class="row"><div class="col-xs-8"><label><i class="fa fa-gbp"></i> Salary</label><div class="row" style="margin-bottom: 10px;"><div class="col-xs-5"><select class="form-control" ng-model="model.jobSalaryType"><option ng-repeat="salaryType in jobSalaryTypes" value="{{salaryType}}"> {{salaryType}} </option></select></div></div><label><i class="fa fa-gbp"></i> From:</label><div class="form-group" style="margin-bottom: 10px;"><input name="jobSalaryStartAt" ng-model="model.jobSalaryStartAt" required class="form-control" placeholder="<Base salary or start at>" type="number"></div><div data-ng-messages="(formName.$submitted && formName.jobSalaryStartAt.$error) || (formName.jobSalaryStartAt.$dirty && formName.jobSalaryStartAt.$error)" class="help-block"><div data-ng-message="required">- The <b>start or base salary</b> is required.</div></div><label><i class="fa fa-gbp"></i> To:</label><div class="form-group" style="margin-bottom: 10px;"><input name="jobSalaryEndAt" ng-model="model.jobSalaryEndAt" required class="form-control" placeholder="<End at>" type="number"></div><div data-ng-messages="(formName.$submitted && formName.jobSalaryEndAt.$error) || (formName.jobSalaryEndAt.$dirty && formName.jobSalaryEndAt.$error)" class="help-block"><div data-ng-message="required">- The <b> max salary </b> is required.</div></div><div class="checkbox"><label><input ng-model="model.jobHasBonus" type="checkbox"> The job Has Bonus?</label></div><div class="checkbox" style="margin-bottom: 0;"><label><input ng-model="model.jobHasBenefits" type="checkbox"> The job Has Benefits?</label></div></div></div>',link:function(e){function t(){switch(e.model.jobSalaryType){case"Annual":e.model.jobEstimatedMonthlySalary=e.model.jobSalaryStartAt/12;break;case"Daily":e.model.jobEstimatedMonthlySalary=21.741*e.model.jobSalaryStartAt;break;case"Hourly":e.model.jobEstimatedMonthlySalary=8*e.model.jobSalaryStartAt*21.741}}"undefined"==typeof e.model.jobSalaryStartAt&&(e.model.jobSalaryStartAt=null),"undefined"==typeof e.model.jobSalaryEndAt&&(e.model.jobSalaryEndAt=null),"undefined"==typeof e.model.jobHasBonus&&(e.model.jobHasBonus=!1),"undefined"==typeof e.model.jobHasBenefits&&(e.model.jobHasBenefits=!1),"undefined"==typeof e.model.jobSalaryType&&(e.model.jobSalaryType="Annual"),e.jobSalaryTypes=["Annual","Daily","Hourly"],e.$watch(function(e){return e.model.jobSalaryType},function(){t()}),e.$watch(function(e){return e.model.jobSalaryStartAt},function(){t()})}}}]).directive("recruiterTypesSelect",[function(){return{restrict:"E",scope:{model:"="},template:'<hr class="hr-xs"><label><i class="fa fa-random"></i> Recruiter type</label><div class="row" style="margin-bottom: 10px;"><div class="col-xs-5"><select class="form-control" ng-model="model.jobRecruiterType"><option ng-repeat="type in recruiterTypes" value="{{type}}">{{type}}</option></select></div></div>',link:function(e){"undefined"==typeof e.model.jobRecruiterType&&(e.model.jobRecruiterType="Agency"),e.recruiterTypes=["Agency","Direct Employer"]}}}]).directive("reHomeStatus",[function(){return{restrict:"E",scope:{model:"="},template:'<hr class="hr-xs"><label><i class="fa fa-random"></i> Home status</label><div class="row" style="margin-bottom: 10px;"><div class="col-xs-5"><select class="form-control" ng-model="model.reHomeStatus"><option ng-repeat="option in options" value="{{option}}">{{option}}</option></select></div></div>',link:function(e){"undefined"==typeof e.model.reHomeStatus&&(e.model.reHomeStatus="New"),e.options=["New","Refurbished","Used"]}}}]).directive("reHomeFor",[function(){return{restrict:"E",scope:{model:"="},template:'<hr class="hr-xs"><label><i class="fa fa-random"></i> Home for</label><div class="row" style="margin-bottom: 10px;"><div class="col-xs-5"><select class="form-control" ng-model="model.reHomeFor"><option ng-repeat="option in options" value="{{option}}">{{option}}</option></select></div></div>',link:function(e){"undefined"==typeof e.model.reHomeFor&&(e.model.reHomeFor="Sale"),e.options=["Sale","Rent"]}}}]);publicationsModule.controller("ViewPublicationController",["$scope","$q","$window","$filter","$routeParams","$location","$http","FireRef","$firebaseArray","$firebaseObject","rfc4122","notificationService","Upload","$uibModal","$log",function(e,t,a,i,o,r,n,l,c,s,d,u,p,m,f){function b(e){var a=t.defer(),i=g.child(e),o=s(i);return o.$loaded(function(){"undefined"==typeof o.releaseDate?a.reject():a.resolve({publication:o})},function(e){a.reject(e)}),a.promise}var g=l.child("publications");e.c={},e.barcode={string:"",options:{width:1,height:50,quite:10,format:"CODE128",displayValue:!0,font:"monospace",textAlign:"center",fontSize:12,backgroundColor:"",lineColor:"#000"}},angular.isDefined(o.publicationId)?e.httpRequestPromise=b(o.publicationId).then(function(t){e.publication=t.publication,e.publicationImages=[],e.barcode.string=t.publication.barcode,e.seo={url:"https://londres.herokuapp.com/#/view-publication/"+t.publication.$id+"/"+i("slug")(t.publication.title)+".html"},angular.forEach(t.publication.images,function(a,i){a.$id=i,i!==t.publication.featuredImageId?e.publicationImages.push(a):e.publicationImages.unshift(a)})},function(){u.error("This action cannot be completed."),r.path("/")}):(u.error("This action cannot be completed."),r.path("/"))}]).directive("facebook",["$window",function(e){return{restrict:"E",scope:{url:"="},template:'<div class="fb-like" data-href="{{url}}" data-layout="button_count" data-action="like" data-show-faces="true" data-share="true"></div>',link:function(){"undefined"!=typeof e.FB&&e.FB.XFBML.parse()}}}]),publicationsModule.directive("barcodeImg",["$compile","$window",function(e,t){function a(){var e=document.createElement("canvas");return!(!e.getContext||!e.getContext("2d"))}return{restrict:"E",scope:{barcodeString:"=",barcodeOptions:"="},link:function(i,o){var r="",n="";a()?(r='<canvas id="barcode-img"></canvas>',n="canvas"):(r='<img id="barcode-img">',n="img"),o.html(e(r)(i)),"undefined"!=typeof i.barcodeString&&("undefined"==typeof i.barcodeOptions&&(i.barcodeOptions={}),i.$watch(function(){return i.barcodeString},function(e){t.JsBarcode(o.find(n),e,i.barcodeOptions)}))}}}]).directive("barcode",["$window",function(e){return{restrict:"A",require:"ngModel",scope:{barcodeOptions:"="},link:function(t,a,i,o){function r(e){n=e}"undefined"==typeof t.barcodeOptions&&(t.barcodeOptions={});var n;o.$validators.barcode=function(a){var i=document.getElementById("barcode-img");return"undefined"==typeof i&&(i=document.createElement("div")),e.JsBarcode(i,a,t.barcodeOptions,r),n}}}}]).directive("barcodeInput",["rfc4122",function(e){return{restrict:"E",scope:{formName:"=",inputModel:"=",selectModel:"="},template:'<hr class="hr-xs"><div class="row"><div class="col-xs-8"><label><i class="fa fa-barcode"></i> Barcode</label><div class="row" style="margin-bottom: 10px;"><div class="col-xs-5"><select class="form-control" ng-model="selectModel" ng-change="formName.barcode.$dirty = true; formName.barcode.$pristine = false; inputModel = \'\';"><option ng-repeat="barcode in barcode.types" value="{{barcode.type}}">{{barcode.title}}</option></select></div><div class="col-xs-5"><button ng-show="selectModel === \'CODE128\'" class="btn btn-default" type="button" ng-click="setBarcodeCODE128Randomly(); formName.barcode.$dirty = true; formName.barcode.$pristine = false;">Set one CODE128 type randomly</button></div></div><div class="form-group" style="margin-bottom: 10px;"><input name="barcode" ng-model="inputModel" required barcode barcode-options="barcode.options" class="form-control" placeholder="<Place here the bar code>" type="text"></div><div data-ng-messages="(formName.$submitted && formName.barcode.$error) || (formName.barcode.$dirty && formName.barcode.$error)" class="help-block"><div data-ng-message="required">- The <b>barcode</b> is required.</div><div data-ng-message="barcode">- The <b>barcode </b> must be valid.</div></div><barcode-img ng-show="!formName.barcode.$error.barcode"></barcode-img></div></div><div class="alert alert-info alert-xs" style="margin-bottom: 0; margin-top: 10px;" role="alert">NOTE: The <b>barcode</b> is obligatory for all type of publications, if you don\'t have one, you can set one CODE128 type randomly, with the barcode you and the clients can track this publication in many ways, and other publications they can maybe have the same barcode.</div>',link:function(t){t.barcode={types:[{title:"EAN (13)",type:"EAN"},{title:"UPC-A",type:"UPC"},{title:"CODE39",type:"CODE39"},{title:"CODE128",type:"CODE128"},{title:"ITF (Interleaved 2 of 5)",type:"ITF"},{title:"ITF14",type:"ITF14"},{title:"Pharmacode",type:"pharmacode"}],options:{width:1,height:50,quite:10,format:"CODE128",displayValue:!0,font:"monospace",textAlign:"center",fontSize:12,backgroundColor:"",lineColor:"#000"}},t.setBarcodeCODE128Randomly=function(){t.inputModel=e.v4()},t.$watch(function(){return t.selectModel},function(e){t.barcode.options.format=e})}}}]),publicationsModule.factory("imagesService",["$q","$http","$window","Upload",function(e,t,a,i){function o(t,a,o){var r=e.defer();return t.upload=i.upload({url:"https://api.cloudinary.com/v1_1/berlin/upload",fields:{public_id:a,upload_preset:"ebdyaimw",context:"alt="+t.name+"|caption="+t.name+"|photo="+t.name+"|$id="+a,tags:[o]},file:t}).progress(function(e){t.progress=Math.round(100*e.loaded/e.total)}).success(function(e){t.inServer=!0,t.$id=e.context.custom.$id,r.resolve({$id:e.context.custom.$id})}).error(function(e){t.details=e,r.reject()}),r.promise}return{deleteImages:function(a,i){var o=e.defer(),r={publicationId:a};return"undefined"!=typeof i&&Array.isArray(i)&&(r.public_ids=i),t({method:"DELETE",url:"/files",params:r}).then(function(e){o.resolve(e)},function(e){o.reject(e)}),o.promise},saveFiles:function(t,i,r){var n=t.child(i).child("images"),l={},c={};return angular.forEach(r,function(e){if(!angular.isDefined(e.inServer)){var t=n.push();c[t.key()]=t,l[t.key()]=o(e,t.key(),i).then(function(t){return c[t.$id].set({name:e.name,size:e.size,type:e.type,width:e.width,height:e.height,inServer:!0,addedDate:a.Firebase.ServerValue.TIMESTAMP})})}}),e.all(l)},saveFiles2:function(t,i,o){var r=t.child(i).child("images"),n={},l={};return angular.forEach(o,function(e){if(!angular.isDefined(e.inServer)){var t=r.push();l[t.key()]=t,n[t.key()]=Upload.upload({url:"https://api.cloudinary.com/v1_1/berlin/upload",data:{file:e,public_id:t.key(),upload_preset:"ebdyaimw",context:"alt="+e.name+"|caption="+e.name+"|photo="+e.name+"|$id="+t.key(),tags:i}}).then(function(t){return e.inServer=!0,e.$id=t.data.public_id,l[t.data.public_id].set({name:t.data.original_filename+"."+t.data.format,size:t.data.bytes,type:t.data.format,width:t.data.width,height:t.data.height,inServer:!0,addedDate:a.Firebase.ServerValue.TIMESTAMP})},function(t){e.details=t},function(t){e.progress=Math.round(100*t.loaded/t.total)})}}),e.all(n)},featuredImage:function(t,a){function i(e){e?o.reject(e):o.resolve()}var o=e.defer(),r={};return angular.isDefined(a)&&""!==a?r.featuredImageId=a:r.featuredImageId="",t.update(r,i),o.promise}}}]).directive("publicationImages",["$q","$filter","FireRef","notificationService","imagesService",function(e,t,a,i,o){return{scope:{formName:"=",images:"=",publicationId:"=",model:"=",httpRequestPromise:"="},templateUrl:"publicationImages.html",link:function(r){var n=a.child("publications");r.imagesInfo=function(){var e={inQueue:0,inServer:0,invalid:0};return angular.forEach(r.images,function(t){angular.isDefined(t.inServer)||angular.isDefined(t.$error)?angular.isDefined(t.inServer)?e.inServer+=1:e.invalid+=1:e.inQueue+=1}),e},r.deleteAllPublicationImages=function(){o.deleteImages(r.publicationId,null).then(function(){var e=n.child(r.publicationId),t=e.child("images");return t.set({})}).then(function(){angular.copy([],r.images),i.success("The images has been deleted")},function(){i.error("The images cannot be deleted")})},r.setAsPrimaryImage=function(e){var t=n.child(r.publicationId);r.httpRequestPromise=o.featuredImage(t,e).then(function(){r.model.featuredImageId=e,i.success("The file as been selected as featured image.")})},r.removeFile=function(a,l){function c(e){r.images=t("filter")(r.images,function(t,a){return a!==e}),i.success("The file as been delete.")}if(angular.isDefined(l.inServer)){var s={};if(l.$id===r.model.featuredImageId){var d=n.child(r.publicationId);s.blankFeaturedImage=o.featuredImage(d).then(function(){r.model.featuredImageId=""})}s.deleteImage=o.deleteImages(r.publicationId,[l.$id]).then(function(){var e=n.child(r.publicationId).child("images").child(l.$id);return e.set({})}).then(function(){c(a)},function(e){i.error(e)}),r.httpRequestPromise=e.all(s)}else c(a)},r.removeInvalidFiles=function(){r.images=t("filter")(r.images,function(e){return!angular.isDefined(e.$error)})},r.removeAllQueueFiles=function(){r.images=t("filter")(r.images,function(e){return!(!angular.isDefined(e.inServer)&&!angular.isDefined(e.$error))}),i.success("All queue files have been removed.")}}}}]),publicationsModule.controller("ListPublicationsController",["$scope","$q","$location","$window","algolia","FireRef","$firebaseArray","$routeParams","$filter",function(e,t,a,i,o,r,n,l,c){function s(){var a=t.defer(),o=i.Object.keys(e.algolia.faceting.currentFacets).length,r=0;return e.algolia.req.facetFilters=[],angular.forEach(e.algolia.faceting.currentFacets,function(t,i){t.length>0&&angular.forEach(t,function(t){e.algolia.req.facetFilters.push(i+":"+t.name)}),r++,o===r&&a.resolve()}),a.promise}function d(){function a(){o.search(e.algolia.req).then(function(t){t.query!==e.algolia.req.query?a():(e.algolia.res=t,u("categories"),u("locations"),i.resolve())},function(e){i.reject(e)})}var i=t.defer(),o=f.initIndex(e.algolia.sortOrder.currentIndexName);return a(),i.promise}function u(t){e.algolia.faceting.facetsAvailables[t]=[],angular.forEach(e.algolia.res.facets[t],function(a,i){angular.forEach(b[t],function(o){if(i===o.name)if(angular.isDefined(e.algolia.faceting.currentFacets[t])&&e.algolia.faceting.currentFacets[t].length>0){var r=e._(e.algolia.faceting.currentFacets[t]).last();o.parentId===r.$id&&(o.count=a,e.algolia.faceting.facetsAvailables[t].push(o))}else""===o.parentId&&(o.count=a,e.algolia.faceting.facetsAvailables[t].push(o))})})}function p(){e.algolia.sortOrder.changeIndexName("publications"),angular.copy({},e.algolia.faceting.currentFacets),e.algolia.req.facetFilters=[],e.algolia.req.page=0,e.algolia.pagination.currentPage=1}var m={},f=o.Client("FU6V8V2Y6Q","75b635c7c8656803b0b9e82e0510f266"),b={categories:n(r.child("categories").orderByChild("left")),locations:n(r.child("locations").orderByChild("left"))};m.categories=b.categories.$loaded(),m.locations=b.locations.$loaded(),e.algolia={req:{query:"",facets:"*",typoTolerance:!1,facetFilters:[],hitsPerPage:7,getRankingInfo:1,page:0,highlightPreTag:"<b>",highlightPostTag:"</b>"},res:{},pagination:{maxSize:10,currentPage:1,pageChanged:function(){e.algolia.req.page=e.algolia.pagination.currentPage-1,d()}},sortOrder:{currentIndexName:"publications",changeIndexName:function(t){e.algolia.sortOrder.currentIndexName=t},sortBy:function(){e.algolia.req.page=0,e.algolia.pagination.currentPage=1,d()},options:{Marketplace:[{title:"Relevance",indexName:"publications"},{title:"Low prices publications",indexName:"publications_by_price_asc"},{title:"Highest prices publications",indexName:"publications_by_price_desc"},{title:"Latest publications",indexName:"publications_by_releaseDate_desc"},{title:"Old publications",indexName:"publications_by_releaseDate_asc"}],Jobs:[{title:"Relevance",indexName:"publications"},{title:"Highest salary publications",indexName:"publications_by_salary_desc"},{title:"Low salary publications",indexName:"publications_by_salary_asc"},{title:"Latest publications",indexName:"publications_by_releaseDate_desc"},{title:"Old publications",indexName:"publications_by_releaseDate_asc"}],"Real Estate":[{title:"Relevance",indexName:"publications"},{title:"Low prices publications",indexName:"publications_by_price_asc"},{title:"Highest prices publications",indexName:"publications_by_price_desc"},{title:"Latest publications",indexName:"publications_by_releaseDate_desc"},{title:"Old publications",indexName:"publications_by_releaseDate_asc"}],Transport:[{title:"Relevance",indexName:"publications"},{title:"Low prices publications",indexName:"publications_by_price_asc"},{title:"Highest prices publications",indexName:"publications_by_price_desc"},{title:"Latest publications",indexName:"publications_by_releaseDate_desc"},{title:"Old publications",indexName:"publications_by_releaseDate_asc"}],Services:[{title:"Relevance",indexName:"publications"},{title:"Latest publications",indexName:"publications_by_releaseDate_desc"},{title:"Old publications",indexName:"publications_by_releaseDate_asc"}]}},faceting:{facetsAvailables:{userID:[],categories:[],locations:[],jobType:[],jobRecruiterType:[],jobSalaryType:[],reHomeStatus:[],reHomeFor:[],jobHasBenefits:[],jobHasBonus:[]},currentFacets:{userID:[],categories:[],locations:[],jobType:[],jobRecruiterType:[],jobSalaryType:[],reHomeStatus:[],reHomeFor:[],jobHasBenefits:[],jobHasBonus:[]},treeFacetsMethods:{addFacet:function(t,a){e.algolia.faceting.currentFacets[t]=angular.isDefined(e.algolia.faceting.currentFacets[t])?e.algolia.faceting.currentFacets[t]:[],e.algolia.faceting.currentFacets[t].push(a),e.algolia.req.facetFilters.push(t+":"+a.name),d()},removeAllFacet:function(t){e.algolia.req.page=0,e.algolia.pagination.currentPage=1,angular.copy([],e.algolia.faceting.currentFacets[t]),"categories"===t&&(angular.copy([],e.algolia.faceting.currentFacets.reHomeStatus),angular.copy([],e.algolia.faceting.currentFacets.reHomeFor),angular.copy([],e.algolia.faceting.currentFacets.jobType),angular.copy([],e.algolia.faceting.currentFacets.jobSalaryType),angular.copy([],e.algolia.faceting.currentFacets.jobRecruiterType),angular.copy([],e.algolia.faceting.currentFacets.jobHasBenefits),angular.copy([],e.algolia.faceting.currentFacets.jobHasBonus)),s().then(function(){e.algolia.sortOrder.changeIndexName("publications"),d()})},removeFacet:function(t,a,i){var o=[];angular.copy(e.algolia.faceting.currentFacets[t],o),angular.copy([],e.algolia.faceting.currentFacets[t]);for(var r=0;i>=r;r++)e.algolia.faceting.currentFacets[t].push(o[r]),r===i&&s().then(function(){d()})}},facetsMethods:{addFacet:function(t,a){var i={};i.name=a,e.algolia.faceting.currentFacets[t]=angular.isDefined(e.algolia.faceting.currentFacets[t])?e.algolia.faceting.currentFacets[t]:[],e.algolia.faceting.currentFacets[t].push(i),e.algolia.req.facetFilters.push(t+":"+i.name),d()},removeFacet:function(t){angular.copy([],e.algolia.faceting.currentFacets[t]),s().then(function(){e.algolia.sortOrder.changeIndexName("publications"),d()})}}}},e.submit=function(){p(),d().then(null,function(e){notificationService.error(e)})};var g=t.defer();e.httpRequestPromise=g.promise,t.all(m).then(function(){e.$watch(function(){return e.algolia.req.query},function(){if(p(),"undefined"!=typeof e.account){var t={};t.name=e.account.user.uid,e.algolia.faceting.currentFacets.userID=[],e.algolia.faceting.currentFacets.userID.push(t),e.algolia.req.facetFilters.push("userID:"+t.name)}d().then(null,function(e){notificationService.error(e)})})}).then(function(){e.thePublicationsAreReady=!0,g.resolve()}),e.viewPublication=function(e){
a.path("/view-publication/"+e)},e.editPublication=function(e){a.path("/edit-publication/"+e)}}]);